<div class="banner banner-overlay position-relative">
  <% if @recipe.photo.attached? %>
    <%= cl_image_tag @recipe.photo.key,
      crop: "fill", class: "banner-img"
      %>
  <% else %>
    <img
    data-commons-image
    data-name="<%= j @recipe.name %>"
    alt="<%= h @recipe.name %>"
    loading="lazy"
    class="banner-img">
    <% end %>
    <%= link_to :back, class: "btn btn-secondary banner-back-button" do %>
      <i class="fa-solid fa-arrow-left fa-lg"></i>
    <% end %>
  </div>
  <div class="container mt-3 mb-5">
    <div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center">

      <!-- Left side: badges stacked -->
      <div class="d-flex flex-column">
        <span class="badge text-bg-cSeaGreen my-1 rounded-pill">
          <i class="fa-regular fa-clock"></i>
          <%= @recipe.duration %> Minutes
        </span>
        <span class="badge text-bg-cSeaGreen my-1 rounded-pill">
          <%= @recipe.calories_per_serving.present? ? "#{@recipe.calories_per_serving} kcal/serving" : "kcal â€”" %>
        </span>
      </div>

      <!-- Right side: actions -->
      <div class="d-flex">
        <div id="like_button_<%= @recipe.id %>">
          <%= render "like_button", recipe: @recipe %>
        </div>
        <div id="favorite_button_<%= @recipe.id %>">
          <%= render "favorite_button", recipe: @recipe %>
        </div>
        <div>
          <%= render "review_offcanvas" %>
        </div>
      </div>

    </div>
  </div>

      <div class="col-12">
        <h3 class="text-cWhite mt-3"><%= @recipe.name %></h3>
      </div>
      <div class="col-6">
        <p class="text-cWhite text-start"><%= @recipe.cuisine%></p>
      </div>
      <div class="col-6">
        <p class="text-cWhite text-end"><%= @recipe.diet %></p>
      </div>
      <div class="col-12">
  <section class="fd-recipe-steps" aria-label="Directions">
    <% if @recipe.directions_html.present? %>
      <div class="fd-steps-html">
        <%= raw @recipe.directions_html %>   <!-- ðŸ‘ˆ usa el HTML generado por el prompt -->
      </div>
    <% else %>
  <%# Fallback si no hay directions_html: genera tÃ­tulo+cuerpo sin duplicados %>
  <ol class="list-group list-group-numbered">
    <% @recipe.directions.to_s.split(/\n+/).each do |raw| %>
      <% step = raw.sub(/^\s*\d+\)?[.)]?\s*/,'').strip %>
      <% next if step.blank? %>

      <% parts = step.split(/\s*[:â€“â€”-]\s*/, 2) %>
      <% title = parts[0].presence || step %>
      <% body  = parts[1].presence || nil %>
      <% show_body = body.present? && body.strip.casecmp(title.strip) != 0 %>

      <li class="list-group-item d-flex justify-content-between align-items-start">
        <div class="ms-2 me-auto">
          <div class="fw-bold"><%= title.truncate(150) %></div>
          <% if show_body %><div><%= body %></div><% end %>
        </div>
      </li>
    <% end %>
  </ol>
<% end %>

  </section>
</div>

    </div>
    <br>
    <section
  data-controller="servings"
  data-servings-base-value="<%= @recipe.try(:base_servings) || 2 %>"
  data-servings-hint-selector-value="#servingHint">
      <h3 class="text-light d-flex align-items-center gap-2">
        Ingredients
        <span class="fd-text-muted small" id="servingHint"></span>
      </h3>
      <!-- RANGE SLIDER -->
      <div class="d-flex align-items-center gap-3 my-2">
        <label class="text-light m-0" for="servingsRange">Servings</label>
        <input type="range"
           id="servingsRange"
           class="fd-range"
           min="1" max="20" step="1"
           value="<%= @recipe.try(:base_servings) || 2 %>"
           data-servings-target="input"
           data-action="input->servings#update change->servings#update">
        <output class="text-light fw-semibold" data-servings-target="output">
          <%= @recipe.try(:base_servings) || 2 %>
        </output>
      </div>
      <!-- INGREDIENTS (your API hash: name => amount string) -->
      <div class="d-flex mt-3" style="overflow-y:auto">
        <% @recipe.ingredients.each do |name, amount| %>
          <div class="ingredient-container mx-4 h-25 flex-column">
            <% prompt = "give me a realistic image of the FOOD #{name}, only FOOD(fruits etc)." %>
            <%= image_tag "https://image.pollinations.ai/prompt/#{ERB::Util.url_encode(prompt)}",
                      class: "ingredient rounded-circle", alt: name %>
            <div class="recipe-ingredient-text">
              <p class="text-light text-truncate mt-2 mb-0"><%= name.to_s.capitalize %></p>
              <p class="text-light text-truncate"
             data-servings-target="amount"
             data-name="<%= name %>"
             data-base-amount="<%= amount %>"><%= amount %></p>
            </div>
          </div>
        <% end %>
      </div>
  </div>
</section>

    </div>

</div>
<style>
  /* Recipe steps look â€“ overrides for Bootstrap list-group */
.fd-recipe-steps ol.list-group.list-group-numbered {
  counter-reset: step;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  gap: .75rem;
}

.fd-recipe-steps ol.list-group.list-group-numbered > li.list-group-item {
  position: relative;
  background: #2a2b32 !important;     /* tu card oscuro */
  color: #e9eef5 !important;
  border: 1px solid rgba(255,255,255,.08) !important;
  border-radius: 16px !important;
  padding: 1rem 1rem 1rem 4.25rem !important; /* espacio para el nÃºmero */
  box-shadow: 0 6px 18px rgba(0,0,0,.18);
}

/* Oculta cualquier marcador/numeraciÃ³n que meta Bootstrap o el UA */
.fd-recipe-steps ol.list-group.list-group-numbered > li.list-group-item::marker {
  content: "" !important;
}

/* Tu nÃºmero grande a la izquierda */
.fd-recipe-steps ol.list-group.list-group-numbered > li.list-group-item::before {
  counter-increment: step;
  content: counter(step);
  position: absolute;
  left: 1rem;
  top: 50%;
  transform: translateY(-50%);
  width: 48px;
  height: 48px;
  border-radius: 12px;
  background: #FBB72C;
  color: #111;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 1.1rem;
  box-shadow: inset 0 -2px 0 rgba(0,0,0,.15);
}

/* TÃ­tulo del paso mÃ¡s marcado */
.fd-recipe-steps .fw-bold {
  font-weight: 700 !important;
  font-size: 0.90rem;
  margin-bottom: .15rem;
}

/* Badge de tiempo con tu acento */
.fd-recipe-steps .badge.rounded-pill {
  background: #FBB72C !important;
  color: #111;
  font-weight: 800;
}

@media (max-width: 480px) {
  .fd-recipe-steps ol.list-group.list-group-numbered > li.list-group-item {
    padding: .85rem .85rem .85rem 3.6rem !important;
    border-radius: 14px !important;
  }
  .fd-recipe-steps ol.list-group.list-group-numbered > li.list-group-item::before {
    width: 40px; height: 40px; font-size: 1rem; left: .75rem;
  }
}

</style>
